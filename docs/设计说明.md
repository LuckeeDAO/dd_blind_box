# 设计说明（dd_blind_box）

## 概述
- 固定规模发售：Scale ∈ {Tiny=10, Small=100, Medium=1k, Large=10k, Huge=100k}
- 存款分发：用户按 base（denom+amount）整倍数转账，顺序领取 0..n-1 NFT
- 治理投票：承诺-揭示模型（commit=sha256(addr|reveal|salt)）
- 结算分层：使用 `dd_algorithms_lib`，按 10%/50%/40% 划分一/二/三等奖并资金返还（2x/1x/0.5x）
- **NFT合约实例化**：盲盒合约作为NFT合约的实例化执行者，仅允许盲盒合约实例化NFT合约

## 模块与文件
- `src/state.rs`：存储结构（Config、TokenInfo、Payout、Commit/Reveal、Map 常量）
- `src/msg.rs`：Instantiate/Execute/Query/Migrate 消息与响应结构
- `src/contract.rs`：instantiate/execute/query/migrate 主逻辑
- `src/lib.rs`：模块出口；`src/error.rs`：错误定义

## 状态与存储
- Config：owner、total_supply、base、vote_state、next_token_id、scale、first_prize_count、paused、commit/reveal/closed 三个阶段窗口、**nft_contract（NFT合约地址）、nft_code_id（NFT合约代码ID）**
- **移除本地NFT存储**：改为使用外部NFT合约进行NFT管理
- DEPOSITS：addr → { principal }
- COMMITS/REVEALS：addr → { commitment } / { reveal, salt }
- TIERS：addr → u8（1/2/3；未设置为 0）

## 生命周期流程
1. **实例化（Instantiate）**：设置 scale 与 base，可选 first_prize_count，vote_state=Commit，total_supply 由 scale 决定
2. **NFT合约设置**：
   - `SetNftCodeId`：设置NFT合约代码ID
   - `InstantiateNftContract`：实例化NFT合约，盲盒合约作为铸造者和管理员
   - `SetNftContract`：手动设置NFT合约地址（可选）
3. **存款（Deposit）**：
   - 接受 base denom 的资金
   - 每 base.amount 为一个单位，按整倍数分发 token_id，从 0 递增
   - **通过外部NFT合约进行批量铸造**
   - 记录地址的存入本金（累加）
4. **承诺（CommitVote）**：记录地址的承诺字符串 commitment（推荐使用 sha256 预镜像）
5. **揭示（RevealVote）**：校验 sha256(addr|reveal|salt) 与 commitment 一致，记录 reveal
6. **结算（Finalize）**：
   - 仅拥有者可触发；要求 vote_state=Closed，且在 closed 窗口内，未暂停
   - 读取所有 reveal，结合区块高度、时间、交易索引等熵生成 3 组 u128 值
   - 简化随机策略按 10%/50%/40% 分配一/二/三档（可替换为 `dd_algorithms_lib`）
   - 一等奖返 2x、本金保本、三等奖返 0.5x，按 base.denom 发送资金
   - 将 tier 结果写入 TIERS

## 随机数与分层策略
- 当前实现：基于 `sha256(seed|addr|reveal)` 提取 3 个 u128 值，简化规则将前 10% 记为一档、接下 50% 为二档、其余为三档；限制最大投票人数（防 DoS）。
- 可替换实现：使用 `dd_algorithms_lib` 的 `get_k_dd_rand_num_with_whitelist` 生成不相交集合，满足互斥与可复现性（no_std）。

## 安全与边界
- 提交/揭示状态机控制，避免提前揭示
- 承诺哈希校验防止事后伪造
- 当 `next_token_id >= total_supply` 时停止继续发放 NFT
- 对输入进行了基本健全性判断（空输入、溢出避免等）
- 提供 `paused` 开关；commit/reveal/closed 窗口校验，所有窗口均为可选闭区间（满足已设置维度）

## 管理接口
- `set_base`：仅拥有者，更新基础币种
- `set_paused`：仅拥有者，暂停/恢复
- `set_commit_window`/`set_reveal_window`/`set_closed_window`：仅拥有者，设置阶段窗口（高度/时间）
- `set_vote_state`：仅拥有者，合法状态转换（允许 Commit→Reveal/Closed、Reveal↔Commit、Closed→Commit）
- **`set_nft_code_id`**：仅拥有者，设置NFT合约代码ID
- **`instantiate_nft_contract`**：仅拥有者，实例化NFT合约
- **`set_nft_contract`**：仅拥有者，手动设置NFT合约地址

## NFT合约集成
- **实例化权限控制**：NFT合约的 `allowed_instantiators` 只包含盲盒合约地址
- **铸造者权限**：盲盒合约作为NFT合约的铸造者，拥有批量铸造权限
- **管理员权限**：盲盒合约作为NFT合约的管理员，拥有升级权限
- **回调处理**：通过 `reply` 函数处理NFT合约实例化成功后的地址保存
- **批量铸造**：使用 `BatchMint` 消息进行高效的NFT批量铸造

## CW721 类接口（通过外部NFT合约）
- `transfer_nft` / `approve` / `revoke` / `approve_all` / `revoke_all`
- 查询：`owner_of`、`nft_info`、`approval`、`is_approved_for_all`、`token_uri`、`all_tokens`、`tokens`
- **注意**：NFT相关查询会提示用户直接查询NFT合约

## 扩展建议
- 引入投票时间窗口和自动切换状态
- 更严格的 reveal 规则（最小长度、字符范围）
- 增加批量查询与导出工具（如分页导出所有 tier=1 的地址）
