# 部署说明（Neutron）

## 依赖
- Rust 1.74+，wasm32-unknown-unknown 目标
- neutrond CLI（`neutrond`）
- jq
- 可选：Docker（用于优化构建）
- **luckee_nft 合约代码**：需要先部署NFT合约代码

## 构建
- 开发构建：
```
./scripts/build.sh
```
- 优化构建（需 Docker）：
```
./scripts/buildprod.sh
```
产物：`artifacts/dd_blind_box.wasm`

## 部署流程

### 1. 部署NFT合约代码
首先需要部署 `luckee_nft` 合约代码：
```
# 上传NFT合约代码
neutrond tx wasm store artifacts/luckee_nft.wasm \
  --from KEY --keyring-backend test \
  --chain-id CHAIN_ID --node RPC --gas-prices 0.025untrn \
  --gas auto --yes
```
记录返回的 `code_id`，后续需要用到。

### 2. 部署盲盒合约
```
# pion-1 测试网示例
./scripts/deploy.sh neutron-pion-1 deployer Medium 100 untrn
```
参数说明：
- network：`neutron-pion-1` 或 `neutron-1`
- key_name：本地 key 名（test keyring）
- scale：`Tiny|Small|Medium|Large|Huge`
- base_amount / base_denom：实例化 base
- 可选 rpc、gas_prices、gas_adjustment

### 3. 配置NFT合约
部署完成后，需要配置NFT合约：

#### 3.1 设置NFT合约代码ID
```
neutrond tx wasm execute CONTRACT_ADDRESS '{"set_nft_code_id":{"code_id":NFT_CODE_ID}}' \
  --from KEY --chain-id CHAIN_ID --node RPC --gas-prices 0.025untrn --gas auto --yes
```

#### 3.2 实例化NFT合约
```
neutrond tx wasm execute CONTRACT_ADDRESS '{"instantiate_nft_contract":{"name":"MyBlindBoxNFT","symbol":"MBN","base_uri":"https://example.com/metadata/"}}' \
  --from KEY --chain-id CHAIN_ID --node RPC --gas-prices 0.025untrn --gas auto --yes
```

#### 3.3 验证配置
```
neutrond query wasm contract-state smart CONTRACT_ADDRESS '{"config":{}}' --node RPC
```
确认返回结果中包含 `nft_contract` 和 `nft_code_id` 字段。

### 可选实例化与运维参数
- `first_prize_count`：可选的一等奖中奖人数；未提供时按 scale 使用默认值
- `set_*_window`：可选的 commit/reveal/closed 阶段窗口（区块高度或时间闭区间）
- `set_paused`：可暂停/恢复合约

脚本流程：
1) 构建 wasm
2) `neutrond tx wasm store` 上传，提取 code_id
3) `neutrond tx wasm instantiate` 实例化，打印合约地址
4) **配置NFT合约代码ID和实例化NFT合约**

## 常见问题
- 无法连接 RPC：手动传入第 6 个参数指定 `--node`
- 余额不足：给部署人地址充值 NTRN（测试网可申请水龙头）
- 窗口未命中：检查本地区块时间与高度是否在配置的窗口内
- **NFT合约未设置**：确保先设置NFT合约代码ID，然后实例化NFT合约
- **实例化失败**：检查NFT合约代码ID是否正确，以及是否有足够的权限
